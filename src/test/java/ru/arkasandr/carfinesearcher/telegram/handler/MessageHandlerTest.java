package ru.arkasandr.carfinesearcher.telegram.handler;import org.junit.jupiter.api.BeforeEach;import org.junit.jupiter.api.DisplayName;import org.junit.jupiter.api.Test;import org.junit.jupiter.api.extension.ExtendWith;import org.mockito.Mock;import org.mockito.junit.jupiter.MockitoExtension;import org.telegram.telegrambots.meta.api.methods.send.SendMessage;import org.telegram.telegrambots.meta.api.objects.Chat;import org.telegram.telegrambots.meta.api.objects.Message;import ru.arkasandr.carfinesearcher.model.Car;import ru.arkasandr.carfinesearcher.service.CarService;import ru.arkasandr.carfinesearcher.service.ChatService;import ru.arkasandr.carfinesearcher.service.RequestProcessService;import ru.arkasandr.carfinesearcher.service.ValidateDataService;import ru.arkasandr.carfinesearcher.telegram.keyboards.ReplyKeyboardMaker;import static java.util.Optional.of;import static org.assertj.core.api.Assertions.assertThat;import static org.mockito.BDDMockito.given;import static ru.arkasandr.carfinesearcher.telegram.constants.BotMessageEnum.*;import static ru.arkasandr.carfinesearcher.telegram.constants.ButtonNameEnum.HELP_BUTTON;@ExtendWith(MockitoExtension.class)@DisplayName("Класс MessageHandler")class MessageHandlerTest {    private static final Long ID = 1L;    private static final String REGISTRATION_NUMBER = "A999AA55";    private static final String CERTIFICATE_NUMBER = "77AC123123";    @Mock    private ReplyKeyboardMaker keyboardMaker;    @Mock    private ValidateDataService validateDataService;    @Mock    private ChatService chatService;    @Mock    private CarService carService;    @Mock    private RequestProcessService requestProcessService;    private MessageHandler messageHandler;    @BeforeEach    void setUp() {        messageHandler = new MessageHandler(keyboardMaker, validateDataService, chatService, carService, requestProcessService);    }    @Test    @DisplayName("пользователь ввел /start")    void whenInputTextIsStartThenSendStartMessage() {        Message message = new Message();        Chat chat = new Chat();        chat.setId(ID);        message.setText("/start");        message.setChat(chat);        SendMessage sendMessage = new SendMessage(ID.toString(), START_MESSAGE.getMessage());        sendMessage.enableMarkdown(true);        sendMessage.setReplyMarkup(keyboardMaker.getMainMenuKeyboard());        assertThat(messageHandler.answerMessage(message)).isEqualTo(sendMessage);    }    @Test    @DisplayName("пользователь нажал справку")    void whenInputTextIsHelpThenSendHelpMessage() {        Message message = new Message();        Chat chat = new Chat();        chat.setId(ID);        message.setText(HELP_BUTTON.getButtonName());        message.setChat(chat);        SendMessage sendMessage = new SendMessage(ID.toString(), HELP_MESSAGE.getMessage());        sendMessage.enableMarkdown(true);        sendMessage.setReplyMarkup(keyboardMaker.getMainMenuKeyboard());        assertThat(messageHandler.answerMessage(message)).isEqualTo(sendMessage);    }    @Test    @DisplayName("пользователь ввел корректный регистрационный номер и в системе нет записей без свидетельства о регистрации")    void whenInputTextIsCorrectRegNumberAndNoEntriesWithoutCertNumberThenSendRegNumberMessage() {        Message message = new Message();        Chat chat = new Chat();        chat.setId(ID);        message.setText(REGISTRATION_NUMBER);        message.setChat(chat);        ru.arkasandr.carfinesearcher.model.Chat userChat = new ru.arkasandr.carfinesearcher.model.Chat();        given(validateDataService.validateUserData(ID.toString(), REGISTRATION_NUMBER))                .willReturn(new SendMessage(ID.toString(), REGISTRATION_NUMBER_MESSAGE.getMessage()));        chatService.saveRegistrationNumber(userChat, REGISTRATION_NUMBER);        SendMessage sendMessage = new SendMessage(ID.toString(), SUCCESS_DATA_SENDING.getMessage());        assertThat(messageHandler.answerMessage(message)).isEqualTo(sendMessage);    }    @Test    @DisplayName("пользователь ввел корректный регистрационный номер и в системе есть записи без свидетельства о регистрации")    void whenInputTextIsCorrectRegNumberAndHaveEntriesWithoutCertNumberThenSendExistRequestException() {        Message message = new Message();        Chat chat = new Chat();        chat.setId(ID);        message.setText(REGISTRATION_NUMBER);        message.setChat(chat);        ru.arkasandr.carfinesearcher.model.Chat userChat = new ru.arkasandr.carfinesearcher.model.Chat();        Car car = new Car();        given(validateDataService.validateUserData(ID.toString(), REGISTRATION_NUMBER))                .willReturn(new SendMessage(ID.toString(), REGISTRATION_NUMBER_MESSAGE.getMessage()));        given(carService.findCarWithoutCertificateNumber())                .willReturn(of(car));        chatService.saveRegistrationNumber(userChat, REGISTRATION_NUMBER);        SendMessage sendMessage = new SendMessage(ID.toString(), EXCEPTION_EXISTING_REQUEST.getMessage());        assertThat(messageHandler.answerMessage(message)).isEqualTo(sendMessage);    }    @Test    @DisplayName("пользователь ввел корректный регистрационный номер и в системе есть запись c таким же номером")    void whenInputTextIsCorrectRegNumberAndHaveEntrWithSameRegNumberThenSendExistRegNumberException() {        Message message = new Message();        Chat chat = new Chat();        chat.setId(ID);        message.setText(REGISTRATION_NUMBER);        message.setChat(chat);        ru.arkasandr.carfinesearcher.model.Chat userChat = new ru.arkasandr.carfinesearcher.model.Chat();        Car car = new Car();        given(validateDataService.validateUserData(ID.toString(), REGISTRATION_NUMBER))                .willReturn(new SendMessage(ID.toString(), REGISTRATION_NUMBER_MESSAGE.getMessage()));        given(carService.findCarByRegistrationNumber(REGISTRATION_NUMBER))                .willReturn(of(car));        chatService.saveRegistrationNumber(userChat, REGISTRATION_NUMBER);        SendMessage sendMessage = new SendMessage(ID.toString(), EXCEPTION_EXISTING_REGISTRATION_NUMBER.getMessage());        assertThat(messageHandler.answerMessage(message)).isEqualTo(sendMessage);    }    @Test    @DisplayName("пользователь ввел корректное свидетельство о регистрации ранее, чем регистрационный номер")    void whenInputTextIsCorrectCertNumberBeforeRegNumberThenCertBeforeRegException() {        Message message = new Message();        Chat chat = new Chat();        chat.setId(ID);        message.setText(CERTIFICATE_NUMBER);        message.setChat(chat);        ru.arkasandr.carfinesearcher.model.Chat userChat = new ru.arkasandr.carfinesearcher.model.Chat();        userChat.setId(ID);        Car car = new Car();        given(chatService.findChatByChatId(ID.toString()))                .willReturn(userChat);        given(validateDataService.validateUserData(ID.toString(), CERTIFICATE_NUMBER))                .willReturn(new SendMessage(ID.toString(), CERTIFICATE_NUMBER_MESSAGE.getMessage()));        given(carService.findCarIdWithFullDataAndNotInSendingStatus(ID))                .willReturn(null);        chatService.saveCertificateNumber(userChat, car, CERTIFICATE_NUMBER);        SendMessage sendMessage = new SendMessage(ID.toString(), EXCEPTION_CERTIFICATE_BEFORE_REGISTRATION.getMessage());        assertThat(messageHandler.answerMessage(message)).isEqualTo(sendMessage);    }    @Test    @DisplayName("пользователь ввел корректное свидетельство о регистрации и данные отправились")    void whenInputTextIsCorrectCertNumberAndRequestSend() {        Message message = new Message();        Chat chat = new Chat();        chat.setId(ID);        message.setText(CERTIFICATE_NUMBER);        message.setChat(chat);        ru.arkasandr.carfinesearcher.model.Chat userChat = new ru.arkasandr.carfinesearcher.model.Chat();        userChat.setId(ID);        Car car = new Car();        given(chatService.findChatByChatId(ID.toString()))                .willReturn(userChat);        given(validateDataService.validateUserData(ID.toString(), CERTIFICATE_NUMBER))                .willReturn(new SendMessage(ID.toString(), CERTIFICATE_NUMBER_MESSAGE.getMessage()));        given(carService.findCarByChatIdAndCertificateNumberIsNull(userChat.getId()))                .willReturn(of(car));        chatService.saveCertificateNumber(userChat, car, CERTIFICATE_NUMBER);        SendMessage sendMessage = new SendMessage(ID.toString(), SUCCESS_DATA_SENDING.getMessage());        assertThat(messageHandler.answerMessage(message)).isEqualTo(sendMessage);    }    @Test    @DisplayName("пользователь ввел корректное свидетельство о регистрации и данные готовы к отправлению")    void whenInputTextIsCorrectCertNumberAndDataIsReady() {        Message message = new Message();        Chat chat = new Chat();        chat.setId(ID);        message.setText(CERTIFICATE_NUMBER);        message.setChat(chat);        ru.arkasandr.carfinesearcher.model.Chat userChat = new ru.arkasandr.carfinesearcher.model.Chat();        userChat.setId(ID);        Car car = new Car();        given(chatService.findChatByChatId(ID.toString()))                .willReturn(userChat);        given(validateDataService.validateUserData(ID.toString(), CERTIFICATE_NUMBER))                .willReturn(new SendMessage(ID.toString(), CERTIFICATE_NUMBER_MESSAGE.getMessage()));        given(carService.findCarIdWithFullDataAndNotInSendingStatus(ID))                .willReturn(ID);        chatService.saveCertificateNumber(userChat, car, CERTIFICATE_NUMBER);        SendMessage sendMessage = new SendMessage(ID.toString(), READY_DATA_MESSAGE.getMessage());        assertThat(messageHandler.answerMessage(message)).isEqualTo(sendMessage);    }}