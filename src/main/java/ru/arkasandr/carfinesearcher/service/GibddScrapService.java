package ru.arkasandr.carfinesearcher.service;import com.microsoft.playwright.BrowserContext;import com.microsoft.playwright.Page;import lombok.RequiredArgsConstructor;import lombok.extern.slf4j.Slf4j;import org.springframework.beans.factory.annotation.Value;import org.springframework.stereotype.Service;import ru.arkasandr.carfinesearcher.config.BrowserInitializeConfig;import ru.arkasandr.carfinesearcher.config.GibddInitializeConfig;import ru.arkasandr.carfinesearcher.model.Answer;import ru.arkasandr.carfinesearcher.model.Fine;import ru.arkasandr.carfinesearcher.model.UserData;import java.nio.file.Paths;import java.time.format.DateTimeFormatter;import java.util.ArrayList;import java.util.HashMap;import java.util.List;import java.util.Map;import static java.time.LocalDateTime.now;import static java.time.format.DateTimeFormatter.ofPattern;import static org.apache.commons.collections4.CollectionUtils.isEmpty;@Service@Slf4j@RequiredArgsConstructorpublic class GibddScrapService {    private static final Integer WAIT_BUTTON_TIMEOUT = 5000;    private static final Integer WAIT_SEARCH_RESULT_TIMEOUT = 20000;    private static final Integer START_REG_NUM_INDEX = 0;    private static final Integer END_REG_NUM_INDEX = 6;    private static final String ANSWER_EXCEPTION = "Произошел сбой, повторите запрос позднее";    private static final String FINE_MESSAGE = "В результате проверки были найдены сведения о неуплаченных штрафах";    private static final String FINE_NUMBER = "Номер штрафа";    @Value("${gibdd.fines.url}")    private String fineUrl;    private final GibddInitializeConfig gibddInitializeConfig;    private final BrowserInitializeConfig browserInitialize;    public Answer scrap(UserData data) {        var regNumber = data.getRegNumber().substring(START_REG_NUM_INDEX, END_REG_NUM_INDEX);        var regReg = data.getRegNumber().substring(END_REG_NUM_INDEX);        var certNumber = data.getCertNumber();        BrowserContext context = gibddInitializeConfig.getContext();        Page page = browserInitialize.page(context);        Answer result;        try {            log.info("Start scraping process with regNumber: {} and certNumber: {} ", data.getRegNumber(), data.getCertNumber());            page.navigate(fineUrl);            page.waitForSelector(".checkFinesRegnum", new Page.WaitForSelectorOptions().setTimeout(20000));            page.click("#checkFinesRegnum");            page.type("#checkFinesRegnum", regNumber);            page.click("#checkFinesRegreg");            page.type("#checkFinesRegreg", regReg);            page.click("#checkFinesStsnum");            page.type("#checkFinesStsnum", certNumber);            page.waitForTimeout(WAIT_BUTTON_TIMEOUT);            page.click("text = запросить проверку");            page.waitForTimeout(WAIT_SEARCH_RESULT_TIMEOUT);            var checkingInfo = page.querySelectorAll("#checkFinesSheet > p").get(0).innerText();            var checkingDate = page.querySelectorAll("#checkFinesSheet > p").get(1).innerText();            var checkFines = page.querySelectorAll("#checkFines > p > p");            var noFines = !isEmpty(checkFines);            var checkingMessage = noFines                    ? page.querySelectorAll("#checkFines > p > p").get(0).innerText()                    : FINE_MESSAGE;            if (!noFines) {                var finesList = page.querySelectorAll(".checkResult");                log.info("Query return {} fines", finesList.size());                List<Fine> resultFines = new ArrayList<>(finesList.size());                for (int i = 0; i < finesList.size(); i++) {                    Map<String, String> fineDescription = new HashMap<>();                    var fineRoot = page.querySelectorAll(".checkResult").get(i);                    var fineNumber = fineRoot                            .querySelectorAll("ul > .decis-delimiter")                            .get(0)                            .innerText();                    fineDescription.put(FINE_NUMBER, fineNumber);                    var fineComponentsList = fineRoot                            .querySelectorAll("ul > li");                    for (int j = 0; j < fineComponentsList.size(); j++) {                        var fineComponent = fineComponentsList.get(j);                        var componentKey = fineComponent.querySelectorAll("span").get(0).innerText();                        var componentValue = fineComponent.querySelectorAll("span").get(1).innerText();                        fineDescription.put(componentKey, componentValue);                    }                    //TODO: разобраться с сохранением штрафа: что делать с мапой? дополнять полями Entity? или сделать Fine.Description ?                }            }            log.info("Результаты проверки: \n "                    + "- {};\n"                    + "- {};\n"                    + "- {};", checkingInfo, checkingDate, checkingMessage);            result = Answer.builder()                    .checkingInfo(checkingInfo)                    .checkingDate(checkingDate)                    .checkingMessage(checkingMessage)                    .build();        } catch (Exception e) {            log.info("GibddScrapService error: {}", e.getMessage());            page.screenshot(new Page.ScreenshotOptions().setPath(Paths.get("screenshots/"                    + fileNameFormat() + ".png")));            result = Answer.builder()                    .checkingMessage(ANSWER_EXCEPTION)                    .build();        } finally {            context.browser().close();            log.info("Browser closed");        }        return result;    }    public static String fileNameFormat() {        var date = now();        DateTimeFormatter formatters = ofPattern("dd-MM-yyyy HH:mm:ss");        return date.format(formatters);    }}